// ==========================================================================
// Project:   Ember Touch - Touch and Gesture Library For Ember
// Copyright: ©2011-2012 Tilde Inc. and contributors
//            Portions ©2006-2011 Strobe Inc.
//            Portions ©2008-2011 Apple Inc. All rights reserved.
// License:   Licensed under MIT license (see license.js)
// ==========================================================================


(function(){Em.GestureDelegates=Em.Object.create({_delegates:{},add:function(e){this._delegates[e.get("name")]=e},find:function(e){return this._delegates[e]},clear:function(){this._delegates={}}})})(),function(){var e=Em.get,t=Em.set;Em.Gestures=Em.Object.create({_registeredGestures:null,init:function(){return this._registeredGestures={},this._super()},register:function(e,t){var n=this._registeredGestures;if(n[e]!==undefined)throw new Em.Error(e+" already exists as a registered gesture recognizers. Gesture recognizers must have globally unique names.");n[e]=t},unregister:function(e){var t=this._registeredGestures;t[e]!==undefined&&(t[e]=undefined)},knownGestures:function(){var e=this._registeredGestures;return e?e:{}}})}(),function(){var e=Em.get,t=Em.set;Em.TouchList=Em.Object.extend({touches:null,timestamp:null,init:function(){this._super(),t(this,"touches",[])},addTouch:function(t){var n=e(this,"touches");n.push(t),this.notifyPropertyChange("touches")},updateTouch:function(t){var n=e(this,"touches");for(var r=0,i=n.length;r<i;r++){var s=n[r];if(s.identifier===t.identifier){n[r]=t,this.notifyPropertyChange("touches");break}}},removeTouch:function(t){var n=e(this,"touches");for(var r=0,i=n.length;r<i;r++){var s=n[r];if(s.identifier===t.identifier){n.splice(r,1),this.notifyPropertyChange("touches");break}}},removeAllTouches:function(){t(this,"touches",[])},touchWithId:function(t){var n=null,r=e(this,"touches");for(var i=0,s=r.length;i<s;i++){var o=r[i];if(o.identifier===t){n=o;break}}return n},length:Ember.computed(function(){var t=e(this,"touches");return t.length}).property("touches").cacheable()})}(),function(){}(),function(){Em.AppGestureManager=Em.Object.create({_isBlocked:!1,_blockerView:null,isBlocked:Em.computed(function(){return this.get("_isBlocked")}).property("_isBlocked"),wasBlockedBy:function(e){return e===this.get("_blockerView")},block:function(e){if(this.get("isBlocked"))throw new Error("manager has already blocked the gesture recognizer");if(e.get("simultaneosly"))throw new Error("a view with simultaneosly property true, cannot block the gesture recognizer");this.set("_isBlocked",!0),this.set("_blockerView",e)},unblock:function(e){if(!this.get("isBlocked"))throw new Error("unblock, the gesture recognizer when the recognizer was not blocked. Did you unblock after Start? ");if(e.get("simultaneosly"))throw new Error("a view with simultaneosly property true, cannot unblock the gesture recognizer");var t=this.get("_blockerView");if(e!==t)throw new Error("unblock a view which was not the one which blocked the gesture recognizer");this.set("_isBlocked",!1)},restart:function(){this.set("_isBlocked",!1),this.set("_blockerView",null)}})}(),function(){Em.DelegateRule=Em.Object.extend({gestureDelegate:null,shouldReceiveTouch:function(e,t,n){}})}(),function(){Em.GestureDelegate=Em.Object.extend({name:null,rules:null,init:function(){this._super();var e=this.rules,t=[],n;if(!!e){var r,i;for(r=0,i=e.length;r<i;r++)n=e[r],Em.typeOf(n)==="string"&&(n=Em.getPath(n)),n.isInstance||(n=n.create()),n.gestureDelegate=this,t.push(n)}this.rules=t},shouldReceiveTouch:function(e,t,n){return!0}})}(),function(){var e=Em.get,t=Em.set;Em.GestureManager=Em.Object.extend({gestures:null,view:null,touchStart:function(e,t){return this._invokeEvent("touchStart",e)},touchMove:function(e,t){return this._invokeEvent("touchMove",e)},touchEnd:function(e,t){return this._invokeEvent("touchEnd",e)},touchCancel:function(e,t){return this._invokeEvent("touchCancel",e)},_invokeEvent:function(e,t){var n=this.get("gestures"),r,i,s=!0;i=this.view[e],Em.typeOf(i)==="function"&&i.call(this.view,t);for(var o=0,u=n.length;o<u;o++){r=n[o],i=r[e];if(Em.typeOf(i)==="function"){var a=r.get("delegate"),f;a?(f=this._applyDelegateRules(a,r,this.view,t),f===undefined&&(f=a.shouldReceiveTouch(r,this.view,t))):f=!0,f&&(s=i.call(r,t))}}var l=this.view.get("parentView");if(l){var c=l.get("eventManager");c&&c._invokeEvent(e,t)}return s},_applyDelegateRules:function(e,t,n,r){var i=e.rules,s=i.length;if(s>0){var o,u;for(o=0;o<s;o++){u=i[o].shouldReceiveTouch(t,n,r);if(u!==undefined)return u}}return undefined}})}(),function(){var e=Em.get,t=Em.set;Em.Gesture=Em.Object.extend({state:null,name:null,view:null,gestureIsDiscrete:!1,preventDefaultOnChange:!1,simultaneously:!0,appGestureManager:null,touches:null,numberOfActiveTouches:0,numberOfRequiredTouches:1,delegateName:null,delegate:null,init:function(){this._super(),this.touches=Em.TouchList.create();var e=this.get("delegateName"),t=this.get("delegate");!t&&e&&(t=Em.GestureDelegates.find(e),Em.assert("empty delegate, attempting to set up delegate based on delegateName",t),this.set("delegate",t))},didBecomePossible:function(){},shouldBegin:function(){return!0},didBegin:function(){},didChange:function(){},eventWasRejected:function(){},shouldEnd:function(){return!0},didEnd:function(){},didCancel:function(){},simultaneouslyAllowed:function(){var e=!0;return this.simultaneously||(this.manager.appGestureManager.get("isBlocked")?e=this.manager.appGestureManager.wasBlockedBy(this.view):this.manager.appGestureManager.block(this.view)),e},attemptGestureEventDelivery:function(e){var t=this.notifyViewOfGestureEvent(e);t||this.eventWasRejected()},distance:function(e){if(e.length<2)return 0;var t=e[0],n=e[1],r=t.pageX,i=t.pageY,s=n.pageX,o=n.pageY;return Math.sqrt((r-=s)*r+(i-=o)*i)},centerPointForTouches:function(e){var t=0,n=0;for(var r=0,i=e.length;r<i;r++){var s=e[r];t+=s.pageX,n+=s.pageY}var o={x:t/e.length,y:n/e.length};return o},_objectValues:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(e[n]);return t},notifyViewOfGestureEvent:function(e,t){var n=this.view[e],r=!1;return Em.typeOf(n)==="function"&&(r=n.call(this.view,this,t)),r},toString:function(){return Em.Gesture+"<"+Em.guidFor(this)+">"},_resetState:function(){this.touches.removeAllTouches()},touchStart:function(n){var r=n.originalEvent.targetTouches,i=this.touches,s=e(this,"state");t(i,"timestamp",Date.now());for(var o=0,u=r.length;o<u;o++){var a=r[o];i.touchWithId(a.identifier)===null&&(i.get("length")===e(this,"numberOfRequiredTouches")&&i.removeAllTouches(),i.addTouch(a))}i.get("length")<e(this,"numberOfRequiredTouches")?t(this,"state",Em.Gesture.WAITING_FOR_TOUCHES):this.gestureIsDiscrete?this.shouldBegin()&&this.simultaneouslyAllowed()&&(t(this,"state",Em.Gesture.BEGAN),this.didBegin()):(t(this,"state",Em.Gesture.POSSIBLE),this.didBecomePossible())},touchMove:function(n){var r=e(this,"state");if(r===Em.Gesture.WAITING_FOR_TOUCHES||r===Em.Gesture.ENDED||r===Em.Gesture.CANCELLED)return;var i=n.originalEvent.changedTouches,s=this.touches;t(s,"timestamp",Date.now());for(var o=0,u=i.length;o<u;o++){var a=i[o];s.updateTouch(a)}if(r===Em.Gesture.POSSIBLE&&!this.gestureIsDiscrete)this.shouldBegin()&&this.simultaneouslyAllowed()&&(t(this,"state",Em.Gesture.BEGAN),this.didBegin(),this.didChange(),this.preventDefaultOnChange&&n.preventDefault(),this.attemptGestureEventDelivery(e(this,"name")+"Start"));else if(r===Em.Gesture.BEGAN||r===Em.Gesture.CHANGED)t(this,"state",Em.Gesture.CHANGED),this.didChange(),this.preventDefaultOnChange&&n.preventDefault(),this.gestureIsDiscrete||this.attemptGestureEventDelivery(e(this,"name")+"Change")},touchEnd:function(n){var r=e(this,"state"),i=this.touches;t(i,"timestamp",Date.now());var s=n&&n.originalEvent?n.originalEvent.changedTouches:undefined;if(s)for(var o=0,u=s.length;o<u;o++){var a=s[o];i.updateTouch(a)}this.gestureIsDiscrete?(r===Em.Gesture.BEGAN||r===Em.Gesture.CHANGED)&&this.shouldEnd()&&(t(this,"state",Em.Gesture.ENDED),this.didEnd(),this.attemptGestureEventDelivery(e(this,"name")+"End")):(r===Em.Gesture.BEGAN||r===Em.Gesture.CHANGED)&&this.shouldEnd()&&(t(this,"state",Em.Gesture.ENDED),this.didEnd(),this.attemptGestureEventDelivery(e(this,"name")+"End")),this._resetState()},touchCancel:function(n){var r=e(this,"state");r!==Em.Gesture.CANCELLED&&(t(this,"state",Em.Gesture.CANCELLED),this.didCancel(),this.gestureIsDiscrete||this.notifyViewOfGestureEvent(e(this,"name")+"Cancel")),this._resetState()}}),Em.GestureDirection={Vertical:1,Horizontal:2},Em.OneGestureDirection={Right:1,Left:2,Down:4,Up:8},Em.Gesture.WAITING_FOR_TOUCHES=0,Em.Gesture.POSSIBLE=1,Em.Gesture.BEGAN=2,Em.Gesture.CHANGED=3,Em.Gesture.ENDED=4,Em.Gesture.CANCELLED=5}(),function(){}(),function(){var e=Em.get,t=Em.set;Em.PinchGestureRecognizer=Em.Gesture.extend({scale:1,numberOfRequiredTouches:2,_startingDistanceBetweenTouches:null,_previousTimestamp:null,_previousDistance:0,_deltaThreshold:5,_previousScale:1,didBecomePossible:function(){this._startingDistanceBetweenTouches=this.distance(e(this.touches,"touches")),this._previousDistance=this._startingDistanceBetweenTouches,this._previousTimestamp=e(this.touches,"timestamp")},shouldBegin:function(){var t=this.distance(e(this.touches,"touches"));return Math.abs(t-this._startingDistanceBetweenTouches)>=this._deltaThreshold},didChange:function(){var n=this._previousScale=e(this,"scale"),r=this.touches.timestamp-this._previousTimestamp,i=this.distance(e(this.touches,"touches")),s=i-this._previousDistance;t(this,"velocity",s/r),t(this,"scale",i/this._previousDistance),this._previousTimestamp=e(this.touches,"timestamp"),this._previousDistance=i},eventWasRejected:function(){t(this,"scale",this._previousScale)}}),Em.Gestures.register("pinch",Em.PinchGestureRecognizer)}(),function(){var e=Em.get,t=Em.set;Em.PanGestureRecognizer=Em.Gesture.extend({translation:null,initThreshold:5,direction:Em.GestureDirection.Horizontal|Em.GestureDirection.Vertical,_previousLocation:null,_previousTranslation:null,init:function(){this._super(),t(this,"translation",{x:0,y:0})},didBecomePossible:function(){this._previousLocation=this.centerPointForTouches(e(this.touches,"touches"))},shouldBegin:function(){var t=this._previousLocation,n=this.centerPointForTouches(e(this.touches,"touches")),r=t.x,i=t.y,s=n.x,o=n.y,u=!1;return this.direction&Em.GestureDirection.Vertical&&(u=Math.abs(i-o)>=this.initThreshold),!u&&this.direction&Em.GestureDirection.Horizontal&&(u=Math.abs(r-s)>=this.initThreshold),u},didChange:function(){var n=this._previousLocation,r=this.centerPointForTouches(e(this.touches,"touches")),i={x:r.x,y:r.y};i.x=r.x-n.x,i.y=r.y-n.y,this._previousTranslation=e(this,"translation"),t(this,"translation",i),this._previousLocation=r},eventWasRejected:function(){t(this,"translation",this._previousTranslation)},toString:function(){return Em.PanGestureRecognizer+"<"+Em.guidFor(this)+">"}}),Em.Gestures.register("pan",Em.PanGestureRecognizer)}(),function(){var e=Em.get,t=Em.set;Em.TapGestureRecognizer=Em.Gesture.extend({numberOfTaps:1,delayBetweenTaps:500,tapThreshold:10,gestureIsDiscrete:!0,_initialLocation:null,_waitingTimeout:null,_waitingForMoreTouches:!1,_internalTouches:null,init:function(){this._super(),this._internalTouches=Em.TouchList.create(),Em.assert(e(this,"numberOfRequiredTouches")===1,"TODO: still not prepared for higher number")},shouldBegin:function(){return e(this.touches,"length")===e(this,"numberOfRequiredTouches")},didBegin:function(){this._initialLocation=this.centerPointForTouches(e(this.touches,"touches")),this._internalTouches.addTouch(this.touches[0]),this._waitingForMoreTouches=e(this._internalTouches,"length")<e(this,"numberOfTaps");if(this._waitingForMoreTouches){var t=this;this._waitingTimeout=window.setTimeout(function(){t._waitingFired(t)},this.delayBetweenTaps)}},shouldEnd:function(){var t=this.centerPointForTouches(e(this.touches,"touches")),n=this._initialLocation.x,r=this._initialLocation.y,i=t.x,s=t.y,o=Math.sqrt((n-=i)*n+(r-=s)*r);return Math.abs(o)<this.tapThreshold&&!this._waitingForMoreTouches},didEnd:function(){window.clearTimeout(this._waitingTimeout),this._initialLocation=null,this._internalTouches.removeAllTouches()},_waitingFired:function(){this._initialLocation=null,this._internalTouches.removeAllTouches(),t(this,"state",Em.Gesture.CANCELLED);var n=e(this,"name")+"Cancel";this.attemptGestureEventDelivery(n),this._resetState()},toString:function(){return Em.TapGestureRecognizer+"<"+Em.guidFor(this)+">"}}),Em.Gestures.register("tap",Em.TapGestureRecognizer)}(),function(){var e=Em.get,t=Em.set;Em.PressGestureRecognizer=Em.Gesture.extend({pressPeriodThreshold:500,gestureIsDiscrete:!0,_initialLocation:null,_moveThreshold:10,_initialTimestamp:null,shouldBegin:function(){return e(this.touches,"length")===e(this,"numberOfRequiredTouches")},didBegin:function(){this._initialLocation=this.centerPointForTouches(e(this.touches,"touches")),this._initialTimestamp=e(this.touches,"timestamp")},shouldEnd:function(){var n=this.centerPointForTouches(e(this.touches,"touches")),r=this._initialLocation.x,i=this._initialLocation.y,s=n.x,o=n.y,u=Math.sqrt((r-=s)*r+(i-=o)*i),a=Math.abs(u)<this._moveThreshold,f=e(this.touches,"timestamp"),l=f-this._initialTimestamp>=this.pressPeriodThreshold,c=a&&l;return c||(t(this,"state",Em.Gesture.CANCELLED),this.didCancel()),c},didEnd:function(){this._resetCounters()},didCancel:function(){this._resetCounters()},_resetCounters:function(){this._initialLocation=null,this._initialTimestamp=null},toString:function(){return Em.PressGestureRecognizer+"<"+Em.guidFor(this)+">"}}),Em.Gestures.register("press",Em.PressGestureRecognizer)}(),function(){var e=Em.get,t=Em.set;Em.TouchHoldGestureRecognizer=Em.Gesture.extend({holdPeriod:2e3,moveThreshold:50,gestureIsDiscrete:!0,_endTimeout:null,_targetElement:null,shouldBegin:function(){return e(this.touches,"length")===e(this,"numberOfRequiredTouches")},didBegin:function(){this._initialLocation=this.centerPointForTouches(e(this.touches,"touches"));var n=e(this.touches,"touches")[0].target;t(this,"_target",n);var r=this;this._endTimeout=window.setTimeout(function(){r._endFired(r)},this.holdPeriod)},didChange:function(){var n=this.centerPointForTouches(e(this.touches,"touches")),r=this._initialLocation.x,i=this._initialLocation.y,s=n.x,o=n.y,u=Math.sqrt((r-=s)*r+(i-=o)*i),a=Math.abs(u)<this.moveThreshold;a||(this._disableEndFired(),t(this,"state",Em.Gesture.CANCELLED))},shouldEnd:function(){return this._disableEndFired(),t(this,"state",Em.Gesture.CANCELLED),this.didCancel(),!1},_endFired:function(){this._disableEndFired();if(this.state===Em.Gesture.BEGAN||this.state===Em.Gesture.CHANGED){t(this,"state",Em.Gesture.ENDED);var n=e(this,"name")+"End";this.attemptGestureEventDelivery(n)}},_disableEndFired:function(){window.clearTimeout(this._endTimeout)},toString:function(){return Em.TouchHoldGestureRecognizer+"<"+Em.guidFor(this)+">"}}),Em.Gestures.register("touchHold",Em.TouchHoldGestureRecognizer)}(),function(){var e=Em.get,t=Em.set;Em.SwipeGestureRecognizer=Em.Gesture.extend({cancelPeriod:100,swipeThreshold:50,initThreshold:5,direction:Em.OneGestureDirection.Right,numberOfRequiredTouches:1,swipeDirection:null,_initialLocation:null,_previousLocation:null,_cancelTimeout:null,didBecomePossible:function(){this._previousLocation=this.centerPointForTouches(e(this.touches,"touches"))},shouldBegin:function(){var t=this._previousLocation,n=this.centerPointForTouches(e(this.touches,"touches")),r=t.x,i=t.y,s=n.x,o=n.y,u=!1;return this.direction&Em.OneGestureDirection.Right&&(u=s-r>this.initThreshold),!u&&this.direction&Em.OneGestureDirection.Left&&(u=r-s>this.initThreshold),!u&&this.direction&Em.OneGestureDirection.Down&&(u=o-i>this.initThreshold),!u&&this.direction&Em.OneGestureDirection.Up&&(u=i-o>this.initThreshold),u},didBegin:function(){this._initialLocation=this.centerPointForTouches(e(this.touches,"touches"));var t=this;this._cancelTimeout=window.setTimeout(function(){t._cancelFired(t)},this.cancelPeriod)},didChange:function(){var n=this.centerPointForTouches(e(this.touches,"touches")),r=this._initialLocation.x,i=this._initialLocation.y,s=n.x,o=n.y,u=!1;this.direction&Em.OneGestureDirection.Right&&(u=s-r>this.swipeThreshold,this.swipeDirection=Em.OneGestureDirection.Right),!u&&this.direction&Em.OneGestureDirection.Left&&(u=r-s>this.swipeThreshold,this.swipeDirection=Em.OneGestureDirection.Left),!u&&this.direction&Em.OneGestureDirection.Down&&(u=o-i>this.swipeThreshold,this.swipeDirection=Em.OneGestureDirection.Down),!u&&this.direction&Em.OneGestureDirection.Up&&(u=i-o>this.swipeThreshold,this.swipeDirection=Em.OneGestureDirection.Up);if(u){this._disableCancelFired(),t(this,"state",Em.Gesture.ENDED);var a=e(this,"name")+"End";this.attemptGestureEventDelivery(a),this._resetState()}},shouldEnd:function(){return this._cancelFired(),!1},_cancelFired:function(){this._disableCancelFired(),t(this,"state",Em.Gesture.CANCELLED);var n=e(this,"name")+"Cancel";this.attemptGestureEventDelivery(n),this._resetState()},_disableCancelFired:function(){window.clearTimeout(this._cancelTimeout)},toString:function(){return Em.SwipeGestureRecognizer+"<"+Em.guidFor(this)+">"}}),Em.Gestures.register("swipe",Em.SwipeGestureRecognizer)}(),function(){}(),function(){var e=Em.get,t=Em.set;Em.View.reopen({eventManager:null,init:function(){this._super();var n=Em.Gestures.knownGestures(),r=e(this,"eventManager");if(n&&!r){var i=[],s=Em.GestureManager.create({appGestureManager:Em.AppGestureManager});for(var o in n)if(this[o+"Start"]||this[o+"Change"]||this[o+"End"]){var u;this[o+"Options"]!==undefined&&typeof this[o+"Options"]=="object"?u=this[o+"Options"]:u={},u.name=o,u.view=this,u.manager=s,i.push(n[o].create(u))}t(s,"view",this),t(s,"gestures",i),t(this,"eventManager",s)}},unblockGestureRecognizer:function(){var t=e(this,"eventManager");t.appGestureManager.unblock(this)}})}(),function(){}(),function(){}();