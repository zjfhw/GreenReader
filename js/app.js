// Generated by CoffeeScript 1.3.3
var RSSReader, currentNavJson, listNavJson, mainNavJson, pullDownAction, store, subscriptionData;

store = Lawnchair({
  name: 'entries',
  record: 'entry'
}, function() {});

subscriptionData = Lawnchair({
  name: 'subscript',
  record: 'entry'
}, function() {});

RSSReader = Em.Application.create({
  ready: function() {
    this._super();
    RSSReader.getSubscription();
    RSSReader.navbarController.set('currentPage', mainNavJson);
    return jQT.initbars();
  }
});

mainNavJson = [
  {
    url: '#main-view',
    title: 'Home',
    icon: 'css/png/glyphicons_020_home.png'
  }, {
    url: '#about-view',
    title: 'About',
    icon: 'css/png/glyphicons_195_circle_info.png'
  }, {
    url: '#settings-view',
    title: 'Setting',
    icon: 'css/png/glyphicons_019_cogwheel.png'
  }
];

listNavJson = [
  {
    url: '#',
    title: 'Unread',
    icon: 'css/png/glyphicons_051_eye_open.png',
    countName: 'unreadCount',
    action: 'showUnread'
  }, {
    url: '#',
    title: 'All',
    icon: 'css/png/glyphicons_071_book.png',
    countName: 'itemCount',
    action: 'showAll'
  }, {
    url: '#',
    title: 'Starred',
    icon: 'css/png/glyphicons_049_star.png',
    countName: 'starredCount',
    action: 'showStarred'
  }, {
    url: '#',
    title: 'Read',
    icon: 'css/png/glyphicons_087_log_book.png',
    countName: 'readCount',
    action: 'showRead'
  }
];

currentNavJson = [
  {
    url: '#',
    title: 'Mark as Unread',
    icon: 'css/png/glyphicons_052_eye_close.png',
    action: 'toggleUnread'
  }, {
    url: '#',
    title: 'Star',
    icon: 'css/png/glyphicons_049_star.png',
    action: 'toggleStar'
  }, {
    url: '#',
    title: 'Share',
    icon: 'css/png/glyphicons_326_share.png',
    action: "share"
  }, {
    url: '#',
    title: 'Read in Browser',
    icon: 'css/png/glyphicons_222_share.png',
    action: "inBrowser"
  }
];

RSSReader.FindFeed = function(query) {
  showLoader();
  if (query.substring(0, 6) === 'q=http') {
    RSSReader.GetItemsFromStore(query.substr(2));
    hideLoader();
    return jQT.goTo('main-view', 'flip');
  } else {
    return $.getJSON('https://ajax.googleapis.com/ajax/services/feed/find?v=1.0&' + query + '&callback=?', function(data) {
      console.log('query', data, data.responseData.entries);
      RSSReader.queryResultController.addItem(data.responseData.entries);
      return hideLoader();
    });
  }
};

RSSReader.GetItemsFromStore = function(feed, currentList, callback) {
  var items;
  showLoader();
  store = Lawnchair({
    name: feed,
    record: 'entry'
  }, function() {});
  items = store.all(function(arr) {
    arr.forEach(function(entry) {
      var item;
      item = RSSReader.Item.create(entry);
      return RSSReader.dataController.addItem(item);
    });
    return console.log('entries load form local:', arr.length);
  });
  if (!feed) {
    alert('no url');
    hideLoader();
  }
  console.log('getting sourc as json', 'https://ajax.googleapis.com/ajax/services/feed/load?v=1.0&q=' + feed + '&callback=?');
  return $.getJSON('https://ajax.googleapis.com/ajax/services/feed/load?v=1.0&q=' + feed + '&callback=?', function(data) {
    var feedLink;
    console.log(data.responseData);
    if (!data.responseData || !data.responseData.feed) {
      alert('check your url');
      hideLoader();
    }
    items = data.responseData.feed.entries;
    feedLink = data.responseData.feed.feedUrl;
    items.map(function(entry) {
      var item;
      item = {};
      item.item_id = entry.link;
      item.pub_name = data.responseData.feed.title;
      item.pub_author = entry.creator;
      item.title = entry.title;
      item.feed_link = feedLink;
      item.content = entry.content;
      item.item_link = entry.link;
      item.short_desc = entry.contentSnippet;
      item.pub_date = new Date(entry.publishedDate);
      item.read = false;
      item.key = item.item_id;
      if (RSSReader.dataController.addItem(RSSReader.Item.create(item))) {
        return store.save(item);
      }
    });
    if (!currentList) {
      currentList = "showDefault";
    }
    RSSReader.itemController[currentList]();
    hideLoader();
    if (callback) {
      return callback();
    }
  });
};

RSSReader.clearStore = function(key, callback) {
  Lawnchair({
    name: key
  }, function() {
    return this.nuke();
  });
  if (callback) {
    return callback();
  }
};

RSSReader.getSubscription = function() {
  var items;
  return items = subscriptionData.all(function(arr) {
    arr.forEach(function(entry) {
      var item;
      item = RSSReader.Subscription.create(entry);
      return RSSReader.subscriptionController.addItem(item);
    });
    return console.log('subscription load form local:', arr.length);
  });
};

$(function() {
  var c, v;
  $('#search-news').live('submit', function() {
    console.log('search news', $(this).serialize());
    return RSSReader.FindFeed($(this).serialize());
  });
  $('.swipe').swipe(function(evt, info) {
    console.log('swipe', info.direction);
    if (info.direction === 'right') {
      RSSReader.itemNavController.prev();
    } else if (info.direction === 'left') {
      RSSReader.itemNavController.next();
    }
    return $(this).iscroll().scrollTo(0, 0);
  });
  $('.swipeToDelete').swipe(function(evt, info) {
    var $this;
    console.log('swipe', info.direction);
    $this = $(this);
    if (info.direction === 'right') {
      console.log($this.next());
      $this.addClass('delete');
      return $this.next().removeClass('hide');
    } else if (info.direction === 'left') {
      $this.removeClass('delete');
      return $this.next().addClass('hide');
    }
  });
  v = RSSReader.get('listView');
  if (!v) {
    console.log('list not created');
    v = RSSReader.ListView.create();
    RSSReader.set('listView', v);
    v.appendTo($('#jqt'));
  }
  c = RSSReader.get('currentView');
  if (!c) {
    console.log('current not created');
    c = RSSReader.CurrentView.create();
    RSSReader.set('currentView', c);
    c.appendTo($('#jqt'));
  }
  $('#list-view').live('pageAnimationEnd', function(event, info) {
    if (info.direction === 'in') {
      return RSSReader.navbarController.set('currentPage', listNavJson);
    }
  });
  $('#main-view').live('pageAnimationEnd', function(event, info) {
    if (info.direction === 'in') {
      return RSSReader.navbarController.set('currentPage', mainNavJson);
    }
  });
  return $('#current-view').live('pageAnimationEnd', function(event, info) {
    if (info.direction === 'in') {
      return RSSReader.navbarController.set('currentPage', currentNavJson);
    }
  });
});

pullDownAction = function(scroll) {
  return RSSReader.itemController.refreshList(function() {
    return scroll.refresh();
  });
};

RSSReader.pullinit = function() {
  var pullDownEl, pullDownOffset;
  pullDownEl = $('#pullDown');
  pullDownOffset = 51;
  return $('.pullable').iscroll({
    topOffset: 51,
    onRefresh: function() {
      if (pullDownEl.hasClass('loading')) {
        pullDownEl.removeClass();
        return pullDownEl.find('pullDownLabel').html('PullDown to Refresh');
      }
    },
    onScrollMove: function() {
      if (this.y > 5 && !pullDownEl.hasClass('flip')) {
        pullDownEl.addClass('flip');
        pullDownEl.find('.pullDownLabel').html('Release to Refresh');
        return this.minScrollY = 0;
      } else if (this.y < 5 && !pullDownEl.hasClass('flip')) {
        pullDownEl.removeClass('flip');
        pullDownEl.find('.pullDownLabel').html('Pull down to refresh');
        return this.minScrollY = -pullDownOffset;
      }
    },
    onScrollEnd: function() {
      if (pullDownEl.hasClass('flip')) {
        pullDownEl.addClass('loading');
        pullDownEl.find('.pullDownLabel').html('Loading...');
        return pullDownAction(this);
      }
    }
  });
};

/*
  Create Controller
*/


RSSReader.dataController = Em.ArrayController.create({
  content: [],
  addItem: function(item) {
    var exists, idx, length;
    exists = this.filterProperty('item_id', item.item_id).length;
    if (exists === 0) {
      length = this.get('length');
      idx = this.binarySearch(Date.parse(item.get('pub_date')), 0, length);
      this.insertAt(idx, item);
      return true;
    } else {
      return false;
    }
  },
  binarySearch: function(value, low, high) {
    var mid, midValue;
    if (low === high) {
      return low;
    }
    mid = low + Math.floor((high - low) / 2);
    midValue = Date.parse(this.objectAt(mid).get('pub_date'));
    if (value < midValue) {
      return this.binarySearch(value, mid + 1, high);
    } else if (value > midValue) {
      return this.binarySearch(value, low, mid);
    }
    return mid;
  },
  itemCount: (function() {
    return this.get('length');
  }).property('@each'),
  readCount: (function() {
    return this.filterProperty('read', true).get('length');
  }).property('@each.read'),
  unreadCount: (function() {
    return this.filterProperty('read', false).get('length');
  }).property('@each.read'),
  starredCount: (function() {
    return this.filterProperty('starred', true).get('length');
  }).property('@each.starred')
});

RSSReader.itemController = Em.ArrayController.create({
  content: [],
  currentList: 'showDefault',
  refreshList: function(callbackFn) {
    console.log('currentList', this.get('currentList'));
    return RSSReader.GetItemsFromStore(RSSReader.subscriptionController.get('currentSubscription').url, this.get('currentList'), callbackFn);
  },
  filterBy: function(key, value) {
    return this.set('content', RSSReader.dataController.filterProperty(key, value));
  },
  clearFilter: function() {
    return this.set('content', RSSReader.dataController.get('content'));
  },
  showDefault: function() {
    this.filterBy('read', false);
    return this.set('currentList', 'showUnread');
  },
  showAll: function() {
    console.log('show all');
    this.clearFilter();
    return this.set('currentList', 'showAll');
  },
  showRead: function() {
    this.filterBy('read', true);
    return this.set('currentList', 'showRead');
  },
  showStarred: function() {
    this.filterBy('starred', true);
    return this.set('currentList', 'showStarred');
  },
  showUnread: function() {
    this.filterBy('read', false);
    return this.set('currentList', 'showUnread');
  },
  markAllRead: function() {
    return this.forEach(function(item) {
      return item.set('read', true);
    });
  },
  itemCount: (function() {
    return this.get('length');
  }).property('@each'),
  readCount: (function() {
    return this.filterProperty('read', true).get('length');
  }).property('@each.read'),
  unreadCount: (function() {
    return this.filterProperty('read', false).get('length');
  }).property('@each.read'),
  starredCount: (function() {
    return this.filterProperty('starred', true).get('length');
  }).property('@each.starred')
});

RSSReader.itemNavController = Em.Object.create({
  currentItem: null,
  hasPrev: false,
  hasNext: false,
  select: function(item) {
    var currentIndex;
    if (item) {
      this.set('currentItem', item);
      this.toggleRead(true);
      currentIndex = RSSReader.itemController.content.indexOf(this.get('currentItem'));
      this.set('hasNext', currentIndex + 1 < RSSReader.itemController.get('itemCount'));
      return this.set('hasPrev', currentIndex !== 0);
    } else {
      this.set('hasPrev', false);
      return this.set('hasNext', false);
    }
  },
  toggleRead: function(read) {
    var key;
    if (read === void 0) {
      read = !this.currentItem.get('read');
    }
    this.currentItem.set('read', read);
    key = this.currentItem.get('item_id');
    return store.get(key, function(entry) {
      entry.read = read;
      return store.save(entry);
    });
  },
  toggleUnread: function() {
    return this.toggleRead(false);
  },
  toggleStar: function(star) {
    var key;
    if (star === void 0) {
      star = !this.currentItem.get('starred');
    }
    this.currentItem.set('starred', star);
    key = this.currentItem.get('item_id');
    return store.get(key, function(entry) {
      entry.starred = star;
      return store.save(entry);
    });
  },
  next: function() {
    var currentIndex, nextItem;
    currentIndex = RSSReader.itemController.content.indexOf(this.get('currentItem'));
    nextItem = RSSReader.itemController.content[currentIndex + 1];
    if (nextItem) {
      return this.select(nextItem);
    }
  },
  prev: function() {
    var currentIndex, prevItem;
    currentIndex = RSSReader.itemController.content.indexOf(this.get('currentItem'));
    prevItem = RSSReader.itemController.content[currentIndex - 1];
    if (prevItem) {
      return this.select(prevItem);
    }
  }
});

RSSReader.navbarController = Em.ArrayController.create({
  content: [],
  itemCountBinding: 'RSSReader.dataController.itemCount',
  currentPage: listNavJson,
  changeTab: function() {
    var btn, _i, _len, _ref, _results;
    this.clear();
    _ref = this.get('currentPage');
    _results = [];
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      btn = _ref[_i];
      _results.push(this.pushObject(RSSReader.NavButton.create(btn)));
    }
    return _results;
  },
  pageChange: (function() {
    console.log('page change');
    return this.changeTab();
  }).observes('currentPage'),
  itemCountChange: (function() {
    console.log('itemCount of itemcont change');
    return this.changeTab();
  }).observes('itemCount')
});

RSSReader.queryResultController = Em.ArrayController.create({
  content: [],
  addItem: function(items) {
    var $this;
    this.clear();
    $this = this;
    return items.map(function(item) {
      return $this.pushObject(RSSReader.QueryResult.create(item));
    });
  }
});

RSSReader.subscriptionController = Em.ArrayController.create({
  content: [],
  currentSubscription: null,
  addUrl: null,
  query: '',
  addItem: function(item) {
    var exists;
    if (!item) {
      item = {
        url: this.get('addUrl'),
        title: this.get('query')
      };
    }
    exists = this.filterProperty('url', item.url).length;
    if (exists === 0) {
      item.key = item.url;
      subscriptionData.save(item);
      this.pushObject(RSSReader.Subscription.create(item));
      console.log(this.get('content'));
      return true;
    } else {
      return false;
    }
  },
  removeItem: function(key) {
    var item;
    console.log('deleting', key);
    item = this.filterProperty('url', key);
    if (item[0]) {
      console.log(item, this.get('content').length, this.get('content').indexOf(item[0], this.get('content')));
      this.get('content').removeAt(this.indexOf(item[0]));
    }
    Lawnchair({
      name: key,
      record: 'entry'
    }, function() {
      return this.nuke();
    });
    subscriptionData.remove(key, function() {
      return this.all('console.log(subscript.length)');
    });
    return console.log(this.get('content').length);
  }
});

RSSReader.Item = Em.Object.extend({
  read: false,
  starred: false,
  item_id: null,
  title: null,
  short_desc: null,
  content: null,
  pub_name: null,
  pub_author: null,
  pub_date: null,
  feed_link: null,
  item_link: null
});

RSSReader.NavButton = Em.Object.extend({
  currentListBinding: 'RSSReader.itemController.currentList',
  itemCountBinding: 'RSSReader.dataController.itemCount',
  unreadCountBinding: 'RSSReader.dataController.unreadCount',
  starredCountBinding: 'RSSReader.dataController.starredCount',
  readCountBinding: 'RSSReader.dataController.readCount',
  url: null,
  title: null,
  icon: null,
  currentItemBinding: 'RSSReader.itemNavController.currentItem',
  countName: null,
  count: (function() {
    return this.get(this.get('countName'));
  }).property('countName'),
  enabled: (function() {
    console.log(this.get('currentList'), this.get('action'));
    if (this.get('currentItem')) {
      return (this.get('currentItem').starred === true && this.get('action') === 'toggleStar') || this.get('currentList') === this.get('action');
    }
    return this.get('currentList') === this.get('action');
  }).property('currentList'),
  action: null
});

RSSReader.QueryResult = Em.Object.extend({
  contentSnippet: null,
  link: null,
  title: null,
  url: null
});

RSSReader.Subscription = Em.Object.extend({
  url: null,
  title: null,
  icon: null
});

RSSReader.ListView = Em.View.extend({
  templateName: 'listview',
  elementId: 'list-view'
});

RSSReader.CurrentView = Em.View.extend({
  templateName: 'current',
  elementId: 'current-view'
});

RSSReader.SubscriptionView = Em.CollectionView.extend({
  contentBinding: 'RSSReader.subscriptionController.content',
  tagName: 'ul',
  classNames: ['plastic', 'view'],
  itemViewClass: Em.View.extend({
    tagName: 'li',
    classNames: ['arrow'],
    elementId: (function() {
      return this.get('content').url;
    }).property('content'),
    getstore: function() {
      console.log('click', this.get('elementId'));
      RSSReader.GetItemsFromStore(this.get('elementId'));
      return RSSReader.subscriptionController.set("currentSubscription", this.get('content'));
    },
    "delete": function() {
      console.log('delete', this.get('elementId'));
      return RSSReader.subscriptionController.removeItem(this.get('elementId'));
    }
  }),
  emptyView: Ember.View.extend({
    template: Ember.Handlebars.compile("Your subscription is empty")
  }),
  contentLengthDidChange: (function() {
    console.log('subscription changed', this);
    return Em.run.next(function() {
      return jQT.setPageHeight();
    });
  }).observes('content.length')
});

RSSReader.QueryResultView = Em.CollectionView.extend({
  contentBinding: 'RSSReader.queryResultController.content',
  tagName: 'ul',
  classNames: ['plastic'],
  itemViewClass: Em.View.extend({
    tagName: 'li',
    click: function() {
      RSSReader.subscriptionController.addItem(this.get('content'));
      return jQT.goTo('#main-view', 'flipleft');
    }
  })
});

RSSReader.FooterNavBarView = Em.CollectionView.extend({
  contentBinding: 'RSSReader.navbarController.content',
  tagName: 'ul',
  itemViewClass: Em.View.extend({
    tagName: 'li',
    didInsertElement: function() {
      return Em.run.once(function() {
        return jQT.initTabbar();
      });
    },
    click: function() {
      var $content;
      console.log(this.get('content').get('currentList'), this.get('content'));
      $content = this.get('content');
      if (RSSReader.itemController[this.get('content').get('action')]) {
        return RSSReader.itemController[this.get('content').get('action')]();
      } else if (RSSReader.itemNavController[this.get('content').get('action')]) {
        RSSReader.itemNavController[this.get('content').get('action')]();
        return console.log('in itemNavController');
      }
    }
  })
});

RSSReader.SummaryListView = Em.CollectionView.extend({
  classNames: ['plastic', 'view'],
  tagName: 'ul',
  itemViewClass: Em.View.extend({
    classNameBindings: ['read', 'starred'],
    read: (function() {
      var read;
      return read = this.get('content').get('read');
    }).property('RSSReader.itemController.@each.read'),
    starred: (function() {
      var starred;
      return starred = this.get('content').get('starred');
    }).property('RSSReader.itemController.@each.starred'),
    click: function(evt) {
      var content;
      console.log('select', this.get('content'));
      content = this.get('content');
      RSSReader.itemNavController.select(content);
      return jQT.goTo('#current-view', 'slideleft');
    },
    dateFromNow: (function() {
      return moment(this.get('content').get('pub_date')).fromNow();
    }).property('RSSReader.itemController.@each.pub_date')
  }),
  contentLengthDidChange: (function() {
    var _self;
    console.log('listview changed', this);
    _self = this;
    return Em.run.next(function() {
      return jQT.setPageHeight();
    });
  }).observes('content.length'),
  contentBinding: 'RSSReader.itemController.content',
  didInsertElement: function() {
    console.log('main insert');
    return Em.run.next(function() {
      return RSSReader.pullinit();
    });
  }
});

RSSReader.EntryItemView = Em.View.extend({
  contentBinding: 'RSSReader.itemNavController.currentItem',
  viewDidChange: (function() {
    console.log('view change');
    return jQT.setPageHeight();
  }).observes('content')
});
